<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>어제의 날씨 | 지역별 어제 기온과 날씨 기록</title>
  <meta name="description" content="어제의 날씨는 사용자의 위치를 기준으로 어제의 기온과 날씨를 기록처럼 보여주는 미니멀 웹 프로젝트입니다.">
  <meta name="keywords" content="어제의 날씨, 어제 기온, 어제 몇 도였지, 지역별 어제 날씨">

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a1a" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="어제날씨">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">

  <!-- OG Tags -->
  <meta property="og:title" content="어제의 날씨">
  <meta property="og:description" content="어제의 기온과 날씨를 기록처럼 보여주는 미니멀 웹">
  <meta property="og:image" content="/og">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@khmyznikov/pwa-install/dist/pwa-install.bundle.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%; height: 100lvh;
      overflow: hidden;
      background-color: var(--bg, #1a1a1a);
      background-image: var(--bg-gradient, none);
      transition: background-color 1.2s ease, color 1.2s ease;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text, #fff);
      transition: color 1.2s ease;
    }

    .container {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100lvh;
    }

    .content-wrapper {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      z-index: 1; touch-action: none; will-change: transform;
    }

    .content-wrapper.animating {
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .content {
      text-align: center;
      padding: 2rem;
      width: 100%;
      max-width: 600px;
    }

    /* Pull spinner */
    .pull-spinner {
      position: absolute; top: 80px; left: 50%;
      transform: translateX(-50%) scale(0);
      width: 28px; height: 28px;
      border: 2.5px solid var(--accent-30, rgba(255,255,255,0.3));
      border-top-color: var(--accent-90, rgba(255,255,255,0.9));
      border-radius: 50%;
      opacity: 0; transition: opacity 0.2s, transform 0.2s;
    }
    .pull-spinner.visible { opacity: 1; transform: translateX(-50%) scale(1); }
    .pull-spinner.refreshing { animation: spin 0.7s linear infinite; }

    /* Location */
    .location {
      font-size: clamp(0.75rem, 2vw, 0.9rem);
      font-weight: 500;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      opacity: 0.5;
      cursor: pointer;
      transition: opacity 0.15s ease;
      margin-bottom: 2.5rem;
    }
    .location:hover { opacity: 0.8; }
    .location:active { opacity: 0.3; }

    /* Two-column weather */
    .weather-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(1.5rem, 6vw, 4rem);
      cursor: pointer;
      user-select: none;
    }

    .weather-col {
      text-align: center;
      flex: 0 0 auto;
    }

    .col-label {
      font-size: clamp(0.65rem, 1.8vw, 0.8rem);
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      opacity: 0.4;
      margin-bottom: 0.3rem;
    }

    .col-temp {
      font-size: clamp(3.5rem, 14vw, 8rem);
      font-weight: 700;
      line-height: 1;
      letter-spacing: -0.04em;
      transition: opacity 0.15s ease;
    }
    .weather-row:active .col-temp { opacity: 0.7; }

    .col-unit {
      font-size: clamp(1rem, 3vw, 1.5rem);
      font-weight: 300;
      opacity: 0.4;
      vertical-align: super;
    }

    /* Separator dot */
    .separator {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.2;
      flex-shrink: 0;
    }

    /* Temperature difference */
    .temp-diff {
      margin-top: 1.5rem;
      font-size: clamp(0.8rem, 2.2vw, 1rem);
      font-weight: 500;
      opacity: 0.55;
      letter-spacing: 0.02em;
    }

    /* Branding */
    .branding {
      margin-top: 3rem;
      font-size: clamp(0.6rem, 1.5vw, 0.7rem);
      font-weight: 300;
      letter-spacing: 0.3em;
      text-transform: lowercase;
      opacity: 0.2;
    }

    .loading { font-size: 1.5rem; opacity: 0.5; }
    .error { font-size: 1rem; opacity: 0.7; max-width: 300px; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      z-index: 100;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }

    .modal {
      width: 90%; max-width: 400px; max-height: 70vh;
      background: rgba(30,30,40,0.85);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.12);
      overflow: hidden;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.3s ease;
      color: #fff;
    }
    .modal-overlay.open .modal { transform: scale(1) translateY(0); }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; gap: 10px;
    }

    .modal-search {
      flex: 1; padding: 12px 16px;
      font-size: 16px; font-family: inherit;
      background: rgba(255,255,255,0.08);
      border: none; border-radius: 12px;
      color: #fff; outline: none;
    }
    .modal-search::placeholder { color: rgba(255,255,255,0.35); }

    .gps-btn {
      width: 46px; height: 46px;
      background: rgba(255,255,255,0.08);
      border: none; border-radius: 12px;
      color: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s ease;
    }
    .gps-btn:hover { background: rgba(255,255,255,0.15); }
    .gps-btn:active { background: rgba(255,255,255,0.2); }
    .gps-btn svg { width: 20px; height: 20px; fill: currentColor; }

    .modal-body {
      max-height: calc(70vh - 80px);
      overflow-y: auto; touch-action: pan-y;
      overscroll-behavior: contain;
    }
    .modal-body::-webkit-scrollbar { width: 4px; }
    .modal-body::-webkit-scrollbar-track { background: transparent; }
    .modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

    .city-item {
      padding: 14px 20px; cursor: pointer;
      transition: background 0.15s ease;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .city-item:hover { background: rgba(255,255,255,0.08); }
    .city-item:active { background: rgba(255,255,255,0.12); }
    .city-item.selected { background: rgba(255,255,255,0.1); }
    .city-name { font-size: 16px; font-weight: 500; margin-bottom: 2px; }
    .city-country { font-size: 13px; opacity: 0.45; }
    .city-loading, .city-empty { padding: 40px 20px; text-align: center; opacity: 0.45; font-size: 14px; }

    /* Install button */
    .install-btn {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom));
      left: 50%; transform: translateX(-50%);
      padding: 10px 20px; font-size: 13px;
      font-family: inherit; font-weight: 500;
      background: var(--btn-bg, rgba(255,255,255,0.15));
      border: 1px solid var(--btn-border, rgba(255,255,255,0.2));
      border-radius: 20px;
      color: var(--text, rgba(255,255,255,0.8));
      cursor: pointer; z-index: 10;
      transition: all 0.2s ease;
      opacity: 0.6;
    }
    .install-btn:hover { opacity: 0.9; }
    .install-btn:active { transform: translateX(-50%) scale(0.96); }

    @media (display-mode: standalone) {
      .install-btn { display: none; }
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      z-index: 50;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .loading-overlay.show { opacity: 1; visibility: visible; }

    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--accent-30, rgba(255,255,255,0.2));
      border-top-color: var(--accent-90, rgba(255,255,255,0.8));
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container" x-data="weather()">
    <!-- Loading Overlay -->
    <div class="loading-overlay" :class="{ 'show': fetchingWeather }">
      <div class="loading-spinner"></div>
    </div>

    <div class="content-wrapper"
         :class="{ 'animating': !isDragging }"
         :style="`transform: translateY(${pullDistance}px)`"
         @touchstart="onTouchStart"
         @touchmove="onTouchMove"
         @touchend="onTouchEnd">

      <div class="pull-spinner" :class="{ 'visible': pullDistance > 30, 'refreshing': isRefreshing }"></div>

      <div class="content">
        <template x-if="loading">
          <div class="loading">...</div>
        </template>

        <template x-if="error">
          <div class="error" x-text="error"></div>
        </template>

        <template x-if="!loading && !error">
          <div>
            <div class="location" @click="openModal()" x-text="city"></div>

            <div class="weather-row" @click="toggleUnit()">
              <div class="weather-col">
                <div class="col-label">어제</div>
                <div class="col-temp">
                  <span x-text="useCelsius ? yesterday.tempC : yesterday.tempF"></span><span class="col-unit" x-text="useCelsius ? '°C' : '°F'"></span>
                </div>
              </div>

              <div class="separator"></div>

              <div class="weather-col">
                <div class="col-label">오늘</div>
                <div class="col-temp">
                  <span x-text="useCelsius ? today.tempC : today.tempF"></span><span class="col-unit" x-text="useCelsius ? '°C' : '°F'"></span>
                </div>
              </div>
            </div>

            <div class="temp-diff" @click="toggleUnit()"
                 x-text="tempDiffText()"></div>

            <div class="branding">yesterday's weather</div>
          </div>
        </template>
      </div>
    </div>

    <!-- Install Button -->
    <button class="install-btn" @click="$refs.pwaInstall.showDialog(true)">앱 설치</button>
    <pwa-install
      x-ref="pwaInstall"
      manifest-url="/manifest.json"
      name="어제의 날씨"
      description="어제의 기온과 날씨를 기록처럼 보여주는 미니멀 웹"
      icon="/icons/icon-512.png"
    ></pwa-install>

    <!-- City Selection Modal -->
    <div class="modal-overlay" :class="{ 'open': modalOpen }" @click.self="closeModal()">
      <div class="modal">
        <div class="modal-header">
          <input type="text" class="modal-search" placeholder="Search city..."
                 x-model="searchQuery" @input="debounceSearch()" x-ref="searchInput">
          <button class="gps-btn" @click="useCurrentLocation()" title="Use current location">
            <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
          </button>
        </div>
        <div class="modal-body">
          <template x-if="searching">
            <div class="city-loading">Searching...</div>
          </template>
          <template x-if="!searching && searchQuery.length > 0 && searchResults.length === 0">
            <div class="city-empty">No cities found</div>
          </template>
          <template x-if="!searching && searchQuery.length > 0">
            <template x-for="c in searchResults" :key="c.place_id">
              <div class="city-item" :class="{ 'selected': c.name === city }" @click="selectCity(c)">
                <div class="city-name" x-text="c.name"></div>
                <div class="city-country" x-text="c.country"></div>
              </div>
            </template>
          </template>
          <template x-if="!searching && searchQuery.length === 0">
            <template x-for="c in popularCities" :key="c.name">
              <div class="city-item" :class="{ 'selected': c.name === city }" @click="selectCity(c)">
                <div class="city-name" x-text="c.name"></div>
                <div class="city-country" x-text="c.country"></div>
              </div>
            </template>
          </template>
        </div>
      </div>
    </div>
  </div>

  <script>
    function weather() {
      return {
        loading: true,
        error: null,
        today: { tempC: 0, tempF: 0, weatherType: '' },
        yesterday: { tempC: 0, tempF: 0, weatherType: '' },
        city: '',
        useCelsius: true,
        countryCode: '',
        currentLat: 0,
        currentLon: 0,

        modalOpen: false,
        searchQuery: '',
        searchResults: [],
        searching: false,
        searchTimeout: null,
        fetchingWeather: false,

        pullDistance: 0,
        touchStartY: 0,
        isRefreshing: false,
        isDragging: false,

        popularCities: [
          { name: 'Seoul', country: 'South Korea', lat: 37.5665, lon: 126.9780, countryCode: 'KR' },
          { name: 'Busan', country: 'South Korea', lat: 35.1796, lon: 129.0756, countryCode: 'KR' },
          { name: 'Jeju', country: 'South Korea', lat: 33.4996, lon: 126.5312, countryCode: 'KR' },
          { name: 'Tokyo', country: 'Japan', lat: 35.6762, lon: 139.6503, countryCode: 'JP' },
          { name: 'Osaka', country: 'Japan', lat: 34.6937, lon: 135.5023, countryCode: 'JP' },
          { name: 'Kyoto', country: 'Japan', lat: 35.0116, lon: 135.7681, countryCode: 'JP' },
          { name: 'Fukuoka', country: 'Japan', lat: 33.5904, lon: 130.4017, countryCode: 'JP' },
          { name: 'Beijing', country: 'China', lat: 39.9042, lon: 116.4074, countryCode: 'CN' },
          { name: 'Shanghai', country: 'China', lat: 31.2304, lon: 121.4737, countryCode: 'CN' },
          { name: 'Hong Kong', country: 'Hong Kong', lat: 22.3193, lon: 114.1694, countryCode: 'HK' },
          { name: 'Taipei', country: 'Taiwan', lat: 25.0330, lon: 121.5654, countryCode: 'TW' },
          { name: 'Singapore', country: 'Singapore', lat: 1.3521, lon: 103.8198, countryCode: 'SG' },
          { name: 'Bangkok', country: 'Thailand', lat: 13.7563, lon: 100.5018, countryCode: 'TH' },
          { name: 'Ho Chi Minh City', country: 'Vietnam', lat: 10.8231, lon: 106.6297, countryCode: 'VN' },
          { name: 'Hanoi', country: 'Vietnam', lat: 21.0285, lon: 105.8542, countryCode: 'VN' },
          { name: 'Manila', country: 'Philippines', lat: 14.5995, lon: 120.9842, countryCode: 'PH' },
          { name: 'Jakarta', country: 'Indonesia', lat: -6.2088, lon: 106.8456, countryCode: 'ID' },
          { name: 'Kuala Lumpur', country: 'Malaysia', lat: 3.1390, lon: 101.6869, countryCode: 'MY' },
          { name: 'Mumbai', country: 'India', lat: 19.0760, lon: 72.8777, countryCode: 'IN' },
          { name: 'Delhi', country: 'India', lat: 28.6139, lon: 77.2090, countryCode: 'IN' },
          { name: 'Dubai', country: 'UAE', lat: 25.2048, lon: 55.2708, countryCode: 'AE' },
          { name: 'Istanbul', country: 'Turkey', lat: 41.0082, lon: 28.9784, countryCode: 'TR' },
          { name: 'London', country: 'United Kingdom', lat: 51.5074, lon: -0.1278, countryCode: 'GB' },
          { name: 'Paris', country: 'France', lat: 48.8566, lon: 2.3522, countryCode: 'FR' },
          { name: 'Berlin', country: 'Germany', lat: 52.5200, lon: 13.4050, countryCode: 'DE' },
          { name: 'Amsterdam', country: 'Netherlands', lat: 52.3676, lon: 4.9041, countryCode: 'NL' },
          { name: 'Zurich', country: 'Switzerland', lat: 47.3769, lon: 8.5417, countryCode: 'CH' },
          { name: 'Rome', country: 'Italy', lat: 41.9028, lon: 12.4964, countryCode: 'IT' },
          { name: 'Madrid', country: 'Spain', lat: 40.4168, lon: -3.7038, countryCode: 'ES' },
          { name: 'Barcelona', country: 'Spain', lat: 41.3851, lon: 2.1734, countryCode: 'ES' },
          { name: 'Stockholm', country: 'Sweden', lat: 59.3293, lon: 18.0686, countryCode: 'SE' },
          { name: 'Prague', country: 'Czech Republic', lat: 50.0755, lon: 14.4378, countryCode: 'CZ' },
          { name: 'New York', country: 'United States', lat: 40.7128, lon: -74.0060, countryCode: 'US' },
          { name: 'Los Angeles', country: 'United States', lat: 34.0522, lon: -118.2437, countryCode: 'US' },
          { name: 'San Francisco', country: 'United States', lat: 37.7749, lon: -122.4194, countryCode: 'US' },
          { name: 'Chicago', country: 'United States', lat: 41.8781, lon: -87.6298, countryCode: 'US' },
          { name: 'Toronto', country: 'Canada', lat: 43.6532, lon: -79.3832, countryCode: 'CA' },
          { name: 'Vancouver', country: 'Canada', lat: 49.2827, lon: -123.1207, countryCode: 'CA' },
          { name: 'Sydney', country: 'Australia', lat: -33.8688, lon: 151.2093, countryCode: 'AU' },
          { name: 'Melbourne', country: 'Australia', lat: -37.8136, lon: 144.9631, countryCode: 'AU' },
          { name: 'S\u00e3o Paulo', country: 'Brazil', lat: -23.5505, lon: -46.6333, countryCode: 'BR' },
          { name: 'Buenos Aires', country: 'Argentina', lat: -34.6037, lon: -58.3816, countryCode: 'AR' },
          { name: 'Cairo', country: 'Egypt', lat: 30.0444, lon: 31.2357, countryCode: 'EG' },
          { name: 'Cape Town', country: 'South Africa', lat: -33.9249, lon: 18.4241, countryCode: 'ZA' },
        ],

        weatherLabels: {
          clear: '맑음', cloudy: '흐림', fog: '안개', rain: '비', snow: '눈', storm: '폭풍'
        },

        themes: {
          clear:  { bg: '#f5e6c8', gradient: 'linear-gradient(180deg, #fff5e0 0%, #f0d898 40%, #d4a850 100%)', text: '#4a3518' },
          cloudy: { bg: '#c8d0d8', gradient: 'linear-gradient(180deg, #e0e4ea 0%, #b8c4d0 40%, #8898a8 100%)', text: '#2a3545' },
          fog:    { bg: '#d0c8d8', gradient: 'linear-gradient(180deg, #e0dae8 0%, #c0b4cc 40%, #9888a8 100%)', text: '#302840' },
          rain:   { bg: '#1e3848', gradient: 'linear-gradient(180deg, #2e5468 0%, #1e3848 40%, #0e1c28 100%)', text: '#d0e4f4' },
          snow:   { bg: '#d8e4f0', gradient: 'linear-gradient(180deg, #eef2fa 0%, #c8d8ea 40%, #98b8d0 100%)', text: '#1a2838' },
          storm:  { bg: '#1c1028', gradient: 'linear-gradient(180deg, #302048 0%, #1c1028 40%, #0c0418 100%)', text: '#d0c0e8' },
        },

        weatherLabel(type) {
          return this.weatherLabels[type] || type || ''
        },

        async init() {
          this.fetchingWeather = true
          try {
            const saved = localStorage.getItem('lastCity')
            if (saved) {
              const city = JSON.parse(saved)
              await this.loadWeatherForCity(city)
            } else {
              const pos = await this.getLocation()
              await this.loadWeatherForLocation(pos.lat, pos.lon)
            }
          } catch (err) {
            this.error = err.message || '날씨 정보를 불러올 수 없습니다'
          }
          this.loading = false
          this.fetchingWeather = false
        },

        async loadWeatherForCity(c) {
          const data = await this.fetchWeather(c.lat, c.lon)
          this.applyWeatherData(data, c.name, c.countryCode)
        },

        async loadWeatherForLocation(lat, lon) {
          this.currentLat = lat
          this.currentLon = lon
          const { cityName, countryCode } = await this.getCityName(lat, lon)
          const data = await this.fetchWeather(lat, lon)
          this.applyWeatherData(data, cityName, countryCode)
        },

        applyWeatherData(data, cityName, countryCode) {
          this.today = data.today
          this.yesterday = data.yesterday
          this.city = cityName
          this.countryCode = countryCode
          this.useCelsius = !['US', 'MM', 'LR'].includes(countryCode)
          this.applyTheme(data.today.weatherType)
        },

        toggleUnit() { this.useCelsius = !this.useCelsius },

        tempDiffText() {
          const todayT = this.useCelsius ? this.today.tempC : this.today.tempF
          const yesterdayT = this.useCelsius ? this.yesterday.tempC : this.yesterday.tempF
          const diff = todayT - yesterdayT
          const unit = this.useCelsius ? '°C' : '°F'
          if (diff === 0) return '어제와 같은 온도'
          const arrow = diff > 0 ? '↑' : '↓'
          return `어제보다 ${Math.abs(diff)}${unit} ${diff > 0 ? '높음' : '낮음'} ${arrow}`
        },

        openModal() {
          this.modalOpen = true
          this.searchQuery = ''
          this.searchResults = []
          this.$nextTick(() => { this.$refs.searchInput?.focus() })
        },

        closeModal() { this.modalOpen = false },

        async useCurrentLocation() {
          this.closeModal()
          this.fetchingWeather = true
          try {
            const pos = await this.getLocation()
            await this.loadWeatherForLocation(pos.lat, pos.lon)
            localStorage.removeItem('lastCity')
          } catch (err) {
            this.error = err.message || '위치 정보를 가져올 수 없습니다'
          }
          this.fetchingWeather = false
        },

        debounceSearch() {
          clearTimeout(this.searchTimeout)
          if (this.searchQuery.length < 1) { this.searchResults = []; return }
          this.searchTimeout = setTimeout(() => { this.searchCities() }, 300)
        },

        async searchCities() {
          if (this.searchQuery.length < 1) return
          this.searching = true
          try {
            const res = await fetch(
              `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(this.searchQuery)}&format=json&limit=10&accept-language=en&addressdetails=1`
            )
            const data = await res.json()
            this.searchResults = data
              .filter(item => item.type === 'city' || item.type === 'town' || item.type === 'village' || item.type === 'administrative' || item.class === 'place')
              .map(item => ({
                place_id: item.place_id,
                name: item.address?.city || item.address?.town || item.address?.village || item.name,
                country: item.address?.country || '',
                lat: parseFloat(item.lat),
                lon: parseFloat(item.lon),
                countryCode: item.address?.country_code?.toUpperCase() || ''
              }))
              .filter((v, i, a) => a.findIndex(t => t.name === v.name && t.country === v.country) === i)
              .slice(0, 8)
          } catch { this.searchResults = [] }
          this.searching = false
        },

        async selectCity(c) {
          this.closeModal()
          this.fetchingWeather = true
          try {
            this.currentLat = c.lat
            this.currentLon = c.lon
            const data = await this.fetchWeather(c.lat, c.lon)
            this.applyWeatherData(data, c.name, c.countryCode)
            localStorage.setItem('lastCity', JSON.stringify({
              name: c.name, country: c.country,
              lat: c.lat, lon: c.lon, countryCode: c.countryCode
            }))
          } catch (err) {
            this.error = err.message || '날씨 데이터를 가져올 수 없습니다'
          }
          this.fetchingWeather = false
        },

        getLocation() {
          return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error('위치 정보를 지원하지 않는 브라우저입니다'))
              return
            }
            navigator.geolocation.getCurrentPosition(
              (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
              () => reject(new Error('위치 정보 접근이 거부되었습니다')),
              { timeout: 10000 }
            )
          })
        },

        async getCityName(lat, lon) {
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`)
            const data = await res.json()
            return {
              cityName: data.address?.city || data.address?.town || data.address?.county || 'Unknown',
              countryCode: data.address?.country_code?.toUpperCase() || ''
            }
          } catch { return { cityName: 'Unknown', countryCode: '' } }
        },

        async fetchWeather(lat, lon) {
          const res = await fetch(`/api/weather?lat=${lat}&lon=${lon}`)
          if (!res.ok) throw new Error('날씨 데이터를 가져올 수 없습니다')
          return res.json()
        },

        onTouchStart(e) {
          if (this.modalOpen || this.isRefreshing) return
          this.touchStartY = e.touches[0].clientY
          this.isDragging = true
        },
        onTouchMove(e) {
          if (this.modalOpen || this.isRefreshing) return
          const deltaY = e.touches[0].clientY - this.touchStartY
          this.pullDistance = deltaY > 0 ? Math.pow(deltaY, 0.75) : -Math.pow(Math.abs(deltaY), 0.75)
        },
        async onTouchEnd() {
          this.isDragging = false
          if (this.modalOpen) return
          if (this.pullDistance > 80) {
            this.isRefreshing = true
            this.pullDistance = 70
            await this.refresh()
            await new Promise(r => setTimeout(r, 300))
            this.isRefreshing = false
          }
          this.pullDistance = 0
        },

        async refresh() {
          this.fetchingWeather = true
          try {
            const data = await this.fetchWeather(this.currentLat, this.currentLon)
            this.today = data.today
            this.yesterday = data.yesterday
            this.applyTheme(data.today.weatherType)
          } catch (err) { this.error = err.message }
          this.fetchingWeather = false
        },

        applyTheme(type) {
          const theme = this.themes[type] || { bg: '#e0e0e0', gradient: 'none', text: '#1a1a1a' }
          const root = document.documentElement.style
          root.setProperty('--bg', theme.bg)
          root.setProperty('--bg-gradient', theme.gradient)
          root.setProperty('--text', theme.text)
          document.getElementById('themeColor')?.setAttribute('content', theme.bg)
        }
      }
    }
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload()
        })
      }
      navigator.serviceWorker.register('/sw.js')
    }
  </script>
</body>
</html>
